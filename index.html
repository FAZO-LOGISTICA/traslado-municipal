<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Traslado Municipal — Reservas</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .scrollbar-hide::-webkit-scrollbar{display:none}
    .scrollbar-hide{-ms-overflow-style:none;scrollbar-width:none}
    .chip{ @apply text-sm px-3 py-1 rounded-full border }
    .btn{ @apply px-4 py-2 rounded-xl shadow-sm transition active:scale-[.98]; }
    .btn-primario{ @apply bg-emerald-600 text-white hover:bg-emerald-700; }
    .btn-sec{ @apply bg-slate-200 text-slate-700 hover:bg-slate-300; }
    .card{ @apply bg-white/90 backdrop-blur rounded-2xl shadow p-5; }
    .pill{ @apply inline-flex items-center px-2 py-1 rounded text-xs font-medium; }
  </style>

  <!-- Chart.js para pestaña Datos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Encabezado -->
  <header class="bg-emerald-900 text-white px-4 py-3 sticky top-0 z-50 shadow">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img id="logoTenant" src="./brand-logo.png" alt="Logo" class="w-9 h-9 rounded-full hidden sm:block"/>
        <div>
          <h1 class="text-lg sm:text-2xl font-bold tracking-wide">TRASLADO MUNICIPAL</h1>
          <p id="tenantSubtitle" class="text-emerald-100 text-xs sm:text-sm">Reservas y gestión de vehículos</p>
        </div>
      </div>

      <!-- Navegación -->
      <nav class="hidden md:flex items-center gap-1">
        <button data-tab="registro" class="tablink btn btn-sec">Registro</button>
        <button data-tab="vehiculos" class="tablink btn btn-sec">Vehículos & Horarios</button>
        <button data-tab="reservas"  class="tablink btn btn-sec">Reservas</button>
        <button data-tab="datos"     class="tablink btn btn-sec">Datos</button>
      </nav>

      <div class="md:hidden">
        <select id="tabMobile" class="bg-emerald-800 text-white rounded px-3 py-2">
          <option value="registro">Registro</option>
          <option value="vehiculos">Vehículos & Horarios</option>
          <option value="reservas">Reservas</option>
          <option value="datos">Datos</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Fondo estilo marca de agua -->
  <div class="fixed inset-0 -z-10 opacity-20"
       style="background-image:url('./fondo-valparaiso.jpg');background-size:cover;background-position:center;"></div>

  <main class="max-w-7xl mx-auto p-4 space-y-6">

    <!-- ===================== REGISTRO ===================== -->
    <section id="view-registro" class="space-y-6">
      <div class="card">
        <h2 class="text-2xl font-bold mb-4">Nueva Reserva</h2>

        <form id="formRegistro" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Nombre / Departamento (mínimos que pediste) -->
          <div>
            <label class="block text-sm mb-1">Nombre del Funcionario</label>
            <select id="r-nombre" class="w-full border rounded-lg px-3 py-2">
              <option value="">Seleccione funcionario</option>
            </select>
          </div>

          <div>
            <label class="block text-sm mb-1">Departamento</label>
            <select id="r-depto" class="w-full border rounded-lg px-3 py-2">
              <option value="">Seleccione departamento</option>
            </select>
          </div>

          <!-- (Opcional) Motivo — lo dejamos visible pero si no lo usas, puedes quitarlo -->
          <div class="md:col-span-2">
            <label class="block text-sm mb-1">Motivo del Traslado</label>
            <input id="r-motivo" type="text" placeholder="Ej: Inspección terreno en Placilla"
                   class="w-full border rounded-lg px-3 py-2"/>
          </div>

          <div class="md:col-span-2 flex items-center gap-3">
            <button type="submit" class="btn btn-primario">Guardar Reserva</button>
            <button type="button" id="btnLimpiar" class="btn btn-sec">Cancelar</button>
            <span id="msgRegistro" class="text-sm"></span>
          </div>
        </form>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card">
          <div class="text-sm text-slate-500">Vehículos disponibles</div>
          <div id="kpiDisponibles" class="text-3xl font-bold">—</div>
        </div>
        <div class="card">
          <div class="text-sm text-slate-500">Traslados en curso</div>
          <div id="kpiEnCurso" class="text-3xl font-bold">—</div>
        </div>
      </div>
    </section>

    <!-- ===================== VEHÍCULOS & HORARIOS ===================== -->
    <section id="view-vehiculos" class="hidden space-y-5">
      <div class="card">
        <h2 class="text-2xl font-bold mb-4">Selecciona Vehículo y Horario</h2>

        <div id="listaVehiculos" class="space-y-4"></div>
        <!-- Cada vehículo se renderiza como una tarjeta vertical:
             [FOTO a la izquierda]  [Bloques horarios a la derecha]
             Los bloques ocupados = gris; disponibles = claros con borde -->
      </div>
    </section>

    <!-- ===================== RESERVAS ===================== -->
    <section id="view-reservas" class="hidden space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold">Reservas</h2>
        <div class="flex items-center gap-2">
          <button id="btnRefrescarReservas" class="btn btn-sec">Refrescar</button>
        </div>
      </div>

      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="text-left text-slate-600">
            <tr>
              <th class="py-2 pr-4">Fecha</th>
              <th class="py-2 pr-4">Funcionario</th>
              <th class="py-2 pr-4">Departamento</th>
              <th class="py-2 pr-4">Vehículo</th>
              <th class="py-2 pr-4">Horario</th>
              <th class="py-2 pr-4">Estado</th>
              <th class="py-2">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyReservas" class="align-top"></tbody>
        </table>
      </div>
    </section>

    <!-- ===================== DATOS / ESTADÍSTICAS ===================== -->
    <section id="view-datos" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card">
          <div class="text-xs text-slate-500">Total solicitudes</div>
          <div id="kpiTotal" class="text-2xl font-bold">—</div>
        </div>
        <div class="card">
          <div class="text-xs text-slate-500">Tasa aprobación</div>
          <div id="kpiAprob" class="text-2xl font-bold">—</div>
        </div>
        <div class="card">
          <div class="text-xs text-slate-500">Vehículos activos</div>
          <div id="kpiVehAct" class="text-2xl font-bold">—</div>
        </div>
        <div class="card">
          <div class="text-xs text-slate-500">% Ocupación</div>
          <div id="kpiOcup" class="text-2xl font-bold">—</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="card"><canvas id="chartDeptos" height="220"></canvas></div>
        <div class="card"><canvas id="chartTiempo"  height="220"></canvas></div>
        <div class="card"><canvas id="chartTipos"   height="220"></canvas></div>
      </div>

      <div class="card">
        <h3 class="text-lg font-semibold mb-2">Principales departamentos</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-left text-slate-600">
              <tr>
                <th class="py-2 pr-4">Departamento</th>
                <th class="py-2 pr-4">Solicitudes</th>
                <th class="py-2">% del total</th>
              </tr>
            </thead>
            <tbody id="tbodyDeptos"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- =============== JS =============== -->
  <script>
    // ------------------ Config & Helpers ------------------
    const state = {
      apiUrl: null,     // cargada desde api.json si existe
      reservas: [],     // se usa en Reservas y Datos
      vehiculos: [],    // lista de vehículos
      horariosBase: [   // ejemplo de bloques (puedes ajustar)
        "08:00 - 09:00","09:00 - 10:00","10:00 - 11:00","11:00 - 12:00",
        "12:00 - 13:00","14:00 - 15:00","15:00 - 16:00","16:00 - 17:00"
      ],
      charts: {}
    };

    async function loadApiUrl() {
      try {
        const r = await fetch("./api.json", { cache: "no-store" });
        if (r.ok) {
          const cfg = await r.json();
          state.apiUrl = cfg.webAppUrl || null;
          console.log("API URL:", state.apiUrl);
        }
      } catch (e) {
        console.warn("api.json no encontrado (modo demo).");
      }
    }

    const $ = (sel) => document.querySelector(sel);
    const el = (tag, cls="") => { const n = document.createElement(tag); if (cls) n.className = cls; return n; };

    function setActiveTab(tab){
      // botones desktop
      document.querySelectorAll(".tablink").forEach(b=>{
        const active = b.dataset.tab===tab;
        b.classList.toggle("bg-emerald-600", active);
        b.classList.toggle("text-white", active);
        b.classList.toggle("btn-primario", active);
      });
      // vistas
      ["registro","vehiculos","reservas","datos"].forEach(v=>{
        $("#view-"+v).classList.toggle("hidden", v!==tab);
      });
      $("#tabMobile").value = tab;
      window.scrollTo({top:0,behavior:"smooth"});
    }

    // ------------------ Demo Data (fallback si no hay backend) ------------------
    const DEMO_VEHICULOS = [
      { id:"FORD4X4", tipo:"Ford 4x4", patente:"AB-DF12", capacidad:"5 pax", foto:"./vehiculos/ford4x4.jpg" },
      { id:"CAMIONETA", tipo:"Camioneta", patente:"CD-EF34", capacidad:"3 pax", foto:"./vehiculos/camioneta.jpg" },
      { id:"CARGA", tipo:"Vehículo de carga", patente:"GH-IJ56", capacidad:"1.5t", foto:"./vehiculos/carga.jpg" },
      { id:"VAN", tipo:"Van", patente:"KL-MN78", capacidad:"10 pax", foto:"./vehiculos/van.jpg" },
    ];

    const DEMO_FUNCIONARIOS = ["Ana Pizarro","Carlos Soto","Daniela R.","Gustavo Oliva","Marcela F."];
    const DEMO_DEPTOS = ["Operaciones","DIDECO","Secpla","Aseo y Ornato","Turismo"];

    function loadCombosRegistro(){
      const $n = $("#r-nombre");
      const $d = $("#r-depto");
      $n.innerHTML = `<option value="">Seleccione funcionario</option>` + DEMO_FUNCIONARIOS.map(x=>`<option>${x}</option>`).join("");
      $d.innerHTML = `<option value="">Seleccione departamento</option>` + DEMO_DEPTOS.map(x=>`<option>${x}</option>`).join("");
    }

    // ------------------ Vehículos & Horarios (UI) ------------------
    function renderVehiculos(){
      const cont = $("#listaVehiculos"); cont.innerHTML = "";
      (state.vehiculos.length? state.vehiculos : DEMO_VEHICULOS).forEach(v=>{
        const card = el("div","border rounded-2xl p-4 flex flex-col md:flex-row gap-4 items-start md:items-center");
        const img = el("img","w-full md:w-48 h-32 object-cover rounded-xl bg-slate-200");
        img.src = v.foto || "./vehiculos/vehiculo.jpg"; img.alt = v.tipo;
        const info = el("div","flex-1 w-full");
        info.innerHTML = `
          <div class="flex items-center justify-between gap-2 mb-2">
            <div>
              <div class="text-lg font-semibold">${v.tipo}</div>
              <div class="text-sm text-slate-500">Patente: ${v.patente} · Cap.: ${v.capacidad||"-"}</div>
            </div>
            <span class="pill bg-emerald-100 text-emerald-700 border border-emerald-300">Disponible</span>
          </div>
        `;

        // bloques horarios (derecha)
        const schedule = el("div","grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2");
        state.horariosBase.forEach((h,idx)=>{
          const ocupado = (idx===2 || idx===6); // demo: algunos ocupados
          const b = el("button", "px-3 py-2 rounded-lg border text-sm " + (ocupado
              ? "bg-slate-200 text-slate-500 cursor-not-allowed"
              : "hover:bg-emerald-50 border-emerald-200"));
          b.textContent = h;
          b.disabled = ocupado;
          if(!ocupado){
            b.addEventListener("click", ()=> reservarHorario(v, h));
          }
          schedule.appendChild(b);
        });

        const right = el("div","flex-1 w-full");
        right.appendChild(schedule);

        card.appendChild(img);
        card.appendChild(info);
        card.appendChild(right);
        cont.appendChild(card);
      });
    }

    async function reservarHorario(vehiculo, hora){
      // Guarda selección en memoria para usarla en Registro o enviar directo
      $("#msgRegistro").textContent = `Seleccionaste ${vehiculo.tipo} (${vehiculo.patente}) — ${hora}`;
      setActiveTab("registro");
    }

    // ------------------ Registro (submit) ------------------
    $("#formRegistro")?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const nombre = $("#r-nombre").value.trim();
      const depto  = $("#r-depto").value.trim();
      const motivo = $("#r-motivo").value.trim();

      if(!nombre || !depto){
        $("#msgRegistro").textContent = "⚠️ Nombre y Departamento son obligatorios.";
        $("#msgRegistro").className = "text-red-600";
        return;
      }
      $("#msgRegistro").textContent = "Guardando…";
      $("#msgRegistro").className = "text-slate-600";

      // payload básico (ajústalo a tu Apps Script)
      const data = { op:"crear_reserva", nombre, depto, motivo, timestamp: new Date().toISOString() };

      try{
        if(state.apiUrl){
          const r = await fetch(state.apiUrl, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(data)
          });
          const j = await r.json().catch(()=>({ok:false}));
          if(r.ok && (j.ok || j.result==="ok")){
            $("#msgRegistro").textContent = "✅ Reserva registrada.";
            $("#msgRegistro").className = "text-emerald-700";
            $("#formRegistro").reset();
            await refreshKPIs();
            await cargarReservas();
            await cargarDatos();
            return;
          } else {
            throw new Error(j.message || "Respuesta no válida del backend.");
          }
        } else {
          // DEMO local
          state.reservas.push({
            fecha: new Date().toLocaleString(),
            nombre, depto, vehiculo:"(por asignar)", horario:"(por definir)", estado:"Pendiente"
          });
          $("#msgRegistro").textContent = "✅ (Demo) Reserva registrada localmente.";
          $("#msgRegistro").className = "text-emerald-700";
          $("#formRegistro").reset();
          await refreshKPIs();
          renderReservas();
        }
      } catch(err){
        console.error(err);
        $("#msgRegistro").textContent = "❌ Error al guardar. Revisa la API o api.json.";
        $("#msgRegistro").className = "text-red-600";
      }
    });

    $("#btnLimpiar")?.addEventListener("click", ()=> $("#formRegistro").reset());

    // ------------------ Reservas (tabla) ------------------
    function renderReservas(){
      const tb = $("#tbodyReservas"); tb.innerHTML = "";
      (state.reservas||[]).forEach((r,i)=>{
        const tr = el("tr","border-t");
        tr.innerHTML = `
          <td class="py-2 pr-4">${r.fecha||"-"}</td>
          <td class="py-2 pr-4">${r.nombre||"-"}</td>
          <td class="py-2 pr-4">${r.depto||"-"}</td>
          <td class="py-2 pr-4">${r.vehiculo||"-"}</td>
          <td class="py-2 pr-4">${r.horario||"-"}</td>
          <td class="py-2 pr-4">${r.estado||"Pendiente"}</td>
          <td class="py-2 flex gap-2">
            <button class="btn btn-primario text-xs" onclick="aprobarReserva(${i})">Aprobar</button>
            <button class="btn btn-sec text-xs" onclick="rechazarReserva(${i})">Rechazar</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }

    async function cargarReservas(){
      try{
        if(state.apiUrl){
          const r = await fetch(state.apiUrl + "?op=listar_reservas",{ cache:"no-store" });
          const j = await r.json();
          state.reservas = j.reservas || [];
        } else {
          // demo si no hay backend
          if(state.reservas.length===0){
            state.reservas = [
              { fecha:"2025-09-14 09:00", nombre:"Ana Pizarro", depto:"Operaciones", vehiculo:"Ford 4x4", horario:"10:00 - 11:00", estado:"Aprobada" },
              { fecha:"2025-09-14 10:10", nombre:"Carlos Soto", depto:"DIDECO",     vehiculo:"Van",      horario:"12:00 - 13:00", estado:"Pendiente" }
            ];
          }
        }
      } catch(e){
        console.warn("No se pudo cargar reservas:", e);
      }
      renderReservas();
    }

    async function aprobarReserva(i){
      const it = state.reservas[i]; if(!it) return;
      it.estado = "Aprobada";
      renderReservas();
      await cargarDatos();
    }
    async function rechazarReserva(i){
      const it = state.reservas[i]; if(!it) return;
      it.estado = "Rechazada";
      renderReservas();
      await cargarDatos();
    }
    window.aprobarReserva = aprobarReserva;
    window.rechazarReserva = rechazarReserva;

    // ------------------ KPIs ------------------
    async function refreshKPIs(){
      // En un backend real, traerías estos conteos desde la API
      const disponibles = (state.vehiculos.length || DEMO_VEHICULOS.length);
      const enCurso = (state.reservas||[]).filter(x=>x.estado==="Aprobada").length;
      $("#kpiDisponibles").textContent = disponibles;
      $("#kpiEnCurso").textContent = enCurso;
    }

    // ------------------ Datos / Estadísticas ------------------
    function buildCharts(){
      // destruir si existen
      Object.values(state.charts).forEach(ch=> ch?.destroy?.());
      state.charts = {};

      // agregamos un conteo por depto
      const byDept = {};
      (state.reservas||[]).forEach(r=>{
        if(!r.depto) return;
        byDept[r.depto] = (byDept[r.depto]||0)+1;
      });
      const deptos = Object.keys(byDept);
      const vals   = Object.values(byDept);

      // tiempo (demo simple: últimos N registros)
      const labelsT = (state.reservas||[]).map(r=>r.fecha?.slice(0,10) || "");
      const dataT   = (state.reservas||[]).map(_=>1);

      // tipos de vehículo (demo)
      const byTipo = {};
      (state.reservas||[]).forEach(r=>{
        const t = r.vehiculo || "Sin asignar";
        byTipo[t] = (byTipo[t]||0)+1;
      });

      // KPIs
      $("#kpiTotal").textContent = state.reservas.length;
      const aprob = state.reservas.filter(r=>r.estado==="Aprobada").length;
      $("#kpiAprob").textContent = state.reservas.length? Math.round(100*aprob/state.reservas.length)+"%" : "—";
      $("#kpiVehAct").textContent = (state.vehiculos.length || DEMO_VEHICULOS.length);
      $("#kpiOcup").textContent   = state.reservas.length? Math.round(100*aprob/(state.vehiculos.length||DEMO_VEHICULOS.length))+"%" : "—";

      // Tabla “principales deptos”
      const total = state.reservas.length || 1;
      const tbody = $("#tbodyDeptos"); tbody.innerHTML="";
      deptos
        .map((d,i)=>({ d, v: vals[i] }))
        .sort((a,b)=>b.v-a.v)
        .forEach(it=>{
          const tr = el("tr","border-t");
          tr.innerHTML = `
            <td class="py-2 pr-4">${it.d}</td>
            <td class="py-2 pr-4">${it.v}</td>
            <td class="py-2">${Math.round(100*it.v/total)}%</td>
          `;
          tbody.appendChild(tr);
        });

      // Charts
      state.charts.deptos = new Chart($("#chartDeptos"), {
        type: "bar",
        data: { labels: deptos, datasets: [{ label: "Solicitudes", data: vals }] },
        options: { plugins:{legend:{display:false}}, responsive:true, maintainAspectRatio:false }
      });

      state.charts.tiempo = new Chart($("#chartTiempo"), {
        type: "line",
        data: { labels: labelsT, datasets: [{ label:"Solicitudes", data: dataT }] },
        options: { plugins:{legend:{display:false}}, responsive:true, maintainAspectRatio:false }
      });

      state.charts.tipos = new Chart($("#chartTipos"), {
        type: "doughnut",
        data: { labels: Object.keys(byTipo), datasets: [{ data: Object.values(byTipo) }] },
        options: { responsive:true, maintainAspectRatio:false }
      });
    }

    async function cargarDatos(){
      // si tu backend entrega /estadisticas, puedes reemplazar por fetch.
      buildCharts();
    }

    // ------------------ Init ------------------
    async function init(){
      // Tabs
      document.querySelectorAll(".tablink").forEach(b=>{
        b.addEventListener("click", ()=> setActiveTab(b.dataset.tab));
      });
      $("#tabMobile").addEventListener("change", (e)=> setActiveTab(e.target.value));

      await loadApiUrl();
      // Vehículos (si tuvieras un vehiculos/list.json, lo leemos)
      try{
        const r = await fetch("./vehiculos/list.json",{ cache:"no-store" });
        if(r.ok){ state.vehiculos = await r.json(); }
      } catch { /* demo fallback */ }

      loadCombosRegistro();
      renderVehiculos();
      await cargarReservas();
      await refreshKPIs();
      await cargarDatos();

      setActiveTab("registro");
    }

    init();
  </script>
</body>
</html>
